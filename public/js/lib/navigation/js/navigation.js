define(function(t){function e(t){return new RegExp("(?:^| )"+t.replace(" "," .* ?")+"(?: |$)")}function n(t){var e=(""+t).split(".");return{e:e[0],ns:e.slice(1).sort().join(" ")}}function r(t,r,a,i){var s,o;return o=n(r),o.ns&&(s=e(o.ns)),t.filter(function(t){return!(!t||o.e&&t.e!==o.e||o.ns&&!s.test(t.ns)||a&&t.cb!==a&&t.cb._cb!==a||i&&t.ctx!==i)})}function a(t,e){return this instanceof a?(e&&$.extend(this,e),this.type=t,this):new a(t,e)}var i=t("mustache"),s=function(t,e){t.show(),t.text(e),setTimeout(function(){t.removeClass("error-tip"),t.addClass("error-tip-fade"),setTimeout(function(){t.removeClass("error-tip-fade"),t.addClass("error-tip"),t.hide()},500)},2e3)},o=function(t){this.settings=$.extend({},o.defaults,t),this.init()};o.prototype={init:function(){this._create()},_create:function(){var t,e,n=this,r=n.settings,a=r.navListObj,i=a.find("ul").first(),s="ui-navigator";n.prevIndex,!i.length&&r.content?(i=$(n.tpl2html("list")),t=n.tpl2html("item"),e="",r.content.forEach(function(n){n=$.extend({href:"",text:""},"string"==typeof n?{text:n}:n),e+=t(n)}),i.append(e).appendTo(a)):(a.is("ul, ol")&&(i=a.wrap("<div>"),a=a.parent()),void 0===r.index&&(r.index=i.find(".ui-state-active").index(),~r.index||(r.index=0))),n.$list=i.addClass(s+"-list"),n.trigger("done",a.addClass(s),r),n.bindEvent(),n.index=-1,n.switchTo(r.index)},_switchTo:function(t,e){if(t!==this.index){var n,r=this,i=r.$list.children(),s=a("beforeselect",e);return r.trigger(s,i.get(t)),n=i.removeClass("ui-state-active").eq(t).addClass("ui-state-active"),r.index=t,r.select(t,n[0])}},switchTo:function(t){return this._switchTo(~~t)},select:function(t,e){var n=this,r=n.settings;void 0===n.prevIndex&&(n.prevIndex=n.index?0:1);var a,o=t>n.prevIndex,l=$(e)[o?"next":"prev"](),c=l.offset()||$(e).offset(),d=r.navListObj.offset();(o?c.left+c.width>d.left+d.width:c.left<d.left)&&(a=n.$list.offset(),r.navListObj.iScroll("scrollTo",o?d.width-c.left+a.left-c.width:a.left-c.left,0,400)),n.prevIndex=t;var u=n.$list.children().eq(t),h=u.attr("data-id"),f=u.attr("data-url"),g=parseInt(u.attr("data-maxPage"));r.navItemContentObj.attr("data-curPage","2"),$.ajax({type:"post",url:f,data:{categoryId:h,page:1},dataType:"json",success:function(t){if(t.flag)if(t.navigatorItems.length){var e={navigatorItems:t.navigatorItems},a=i.render(r.renderTpl.join(""),e);r.navItemContentObj.html(a),1>=g?(r.refreshDownObj.hide(),n.disable("down",!0)):(r.refreshDownObj.show(),n._setStyle("down","loaded"),n.enable("down"))}else r.navItemContentObj.html('<div style="text-align:center;margin-top:80px;color:#A54093;font-size:20px;">暂无数据</div>'),r.refreshDownObj.hide(),n.disable("down",!0);else s(r.errorTipObj,t.msg)},error:function(){s(r.errorTipObj,"请求服务器异常,稍后再试")}})},unselect:function(){this.index=-1,this.$list.children().removeClass("ui-state-active")},getIndex:function(){return this.index},trigger:function(t){var e,n,i,s,o,l=-1;if(!this._events||!t)return this;if("string"==typeof t&&(t=new a(t)),e=slice.call(arguments,1),t.args=e,e.unshift(t),n=r(this._events,t.type))for(s=n.length;++l<s;)if((i=t.isPropagationStopped())||!1===(o=n[l]).cb.apply(o.ctx2,e)){i||(t.stopPropagation(),t.preventDefault());break}return this},refresh:function(){this.settings.navListObj.iScroll("refresh")},_changeStyle:function(t,e){var n=this.settings;switch(e){case"loaded":n.refreshLabelObj.html("加载更多"),n.refreshIconObj.removeClass(),n._actDir="";break;case"loading":n.refreshLabelObj.html("加载中..."),n.refreshIconObj.addClass("ui-loading"),n._actDir=t;break;case"disable":n.refreshLabelObj.html("没有更多内容了")}return this},_setStyle:function(t,e){var n=this,r=$.Event("statechange");return n.trigger(r,n.settings["$"+t+"Elem"],e,t),r.defaultPrevented?n:n._changeStyle(t,e)},_status:function(t,e){var n=this.settings;return void 0===e?n["_"+t+"Open"]:n["_"+t+"Open"]=!!e},_setable:function(t,e,n){var r=this,a=r.settings,i=a.refreshDownObj;return i.length?(t?i.show():n?i.hide():r._setStyle(e,"disable"),r._status(e,t),r):void 0},disable:function(t,e){return this._setable(!1,t,e)},enable:function(t){return this._setable(!0,t)},_loadingAction:function(t,e){var n=this,r=(n.settings,n.load);return $.isFunction(r)&&r.call(n,t,e),n._status(t,!1),n},afterDataLoading:function(t){var e=this,t=t||e.settings._actDir;return e._setStyle(t,"loaded"),e._status(t,!0),e},load:function(t){var e=this,n=e.settings.navItemContentObj;parseInt($("li.ui-state-active").attr("data-maxPage"))>=parseInt(n.attr("data-curPage"))&&"down"===t&&$.ajax({type:"post",url:$("li.ui-state-active").attr("data-url"),data:{categoryId:$("li.ui-state-active").attr("data-id"),page:parseInt(n.attr("data-curPage"))},dataType:"json",success:function(t){parseInt($("li.ui-state-active").attr("data-maxPage"))>=parseInt(n.attr("data-curPage"))&&setTimeout(function(){var r=i.render(e.settings.renderTpl.join(""),t);n.append(r),e.afterDataLoading(),n.attr("data-curPage",parseInt(n.attr("data-curPage"))+1),parseInt(n.attr("data-curPage"))>parseInt($("li.ui-state-active").attr("data-maxPage"))&&e.disable("down",!0)},500)},error:function(){s(e.settings.errorTipObj,"请求服务器异常,稍后再试")}})},_startHandler:function(t){this.settings._startY=t.touches[0].pageY},_endHandler:function(){var t=this,e=t.settings;return t._setStyle("down","loading"),t._loadingAction("down","pull"),e._refreshing=!1,t},_moveHandler:function(t){var e=this,n=e.settings,r=n._startY,a=r-t.touches[0].pageY,i=n._win.innerHeight,s=n.threshold||(n.wrapperH<i?n.wrapperH/2+n.wrapperTop||0:i/2);if(e._status("down")&&!(0>a))return!n._refreshing&&r>=n._body.scrollHeight-i+s&&a>10&&(e._setStyle("down","beforeload"),n._refreshing=!0),e},_eventHandler:function(t){var e=this,n=e.settings;switch(t.type){case"touchstart":e._startHandler(t);break;case"touchmove":clearTimeout(n._endTimer),n._endTimer=setTimeout(function(){e._endHandler()},300),e._moveHandler(t);break;case"touchend":case"touchcancel":clearTimeout(n._endTimer),n._refreshing&&e._endHandler();break;case"scrollStop":!n._refreshing&&n._win.pageYOffset>=n._body.scrollHeight-n._win.innerHeight+(n.threshold||-1)&&e._endHandler()}return e},bindEvent:function(){var t,e,n=this,r=n.settings,a=r.navListObj,i=a.find("ul").first(),s=$(document),o=function(){var n=t.attr("hl-cls");clearTimeout(e),t.removeClass(n).removeAttr("hl-cls"),t=null,s.off("touchend touchmove touchcancel",o)},l=function(n,r){return $(r).each(function(){var a=$(this);a.css("-webkit-tap-highlight-color","rgba(255,255,255,0)").off("touchstart.hl"),n&&a.on("touchstart.hl",function(i){var l;t=r?(l=$(i.target).closest(r,this))&&l.length&&l:a,t&&(t.attr("hl-cls",n),e=setTimeout(function(){t.addClass(n)},100),s.on("touchend touchmove touchcancel",o))})})};l("ui-state-hover","li"),i.delegate("li:not(.ui-state-disable)>a","click",function(t){n._switchTo($(this).parent().index(),t)}),$(window).on("resize",function(){n.refresh()}),a.on("destroy",function(){a.iScroll("destroy"),$(window).off("resize")}),a.iScroll(r.iScrollArg),r.pullAreaObj.on("touchstart touchmove touchend touchcancel",function(t){r.wrapperH=r.pullAreaObj.height(),r.wrapperTop=r.pullAreaObj.offset().top,r._win=window,r._body=document.body,n._eventHandler(t)})}},o.defaults={navListObj:null,navItemContentObj:null,pullAreaObj:null,refreshDownObj:null,refreshIconObj:null,refreshLabelObj:null,errorTipObj:null,iScrollArg:{hScroll:!0,vScroll:!1,hScrollbar:!1,vScrollbar:!1,bounce:!1},content:null,isScrollToNext:!0,renderTpl:""};var l=function(t){new o(t)};window.rNavigation=$.rNavigation=$.navigation=l});